# 新的ECMA代码执行描述

其实在前面的学习中，我们学习了很多ECMA文档的术语：（如下所示）

- **执行上下文栈**：用于执行上下文的结构；
- **执行上下文**：代码在执行之前会先创建对应的执行上下文；
- **变量对象**：上下文关联的VO对象，用于记录函数和变量声明；
- **全局对象**：全局执行上下文关联的VO对象；
- **激活对象**：函数执行上下文关联的VO对象；
- **作用域链**：作用域链用于关联指向上下文单变量查找；



对于新的ECMA代码执行描述中，对于代码的执行流程描述改成了另外一些词汇：

- 基本思路基本相同，只是对一些词汇的描述发生了改变；
- 执行上下文和执行上下文栈也是相同的；



## 词法环境（Lexical Environments）

词法环境是一种规范类型，用于在词法嵌套结构中定义关联的变量，函数等标识符。

- 一个词法环境是有`环境记录`和一个`外部词法`环境组成；

- 一个词法环境经常用于关联一个函数声明，代码块语句，try-catch语句，当他们的代码执行时，词法环境被创建出来。

  

> 词法环境（Lexical Environment）和VO对象（Variable Object）是两个在JavaScript中处理变量和作用域的概念。它们之间有一些区别：
>
> 1. 词法环境（Lexical Environment）：
>    - 词法环境是JavaScript引擎用来管理标识符（变量、函数等）与其值的映射关系的内部数据结构。
>    - 每个函数在定义时都会创建一个词法环境，用于保存该函数内部的局部变量和函数声明。
>    - 词法环境是根据代码中的作用域嵌套关系来构建的，可以形成一个链式结构，即作用域链（Scope Chain）。
>    - 当执行JavaScript代码时，引擎会根据当前执行上下文的词法环境来查找标识符的值。
> 2. VO对象（Variable Object）：
>    - VO对象是在函数执行上下文中用于保存该函数内部的变量和函数声明的一个内部对象。
>    - VO对象是词法环境的一个具体实现，用于表示函数的作用域。
>    - 在函数执行过程中，VO对象是词法环境的组成部分，存储了函数内部声明的变量和函数。
>
> 虽然词法环境和VO对象都用于管理作用域和标识符的映射关系，但VO对象是词法环境的一部分，是词法环境的一个具体表现形式。词法环境是更广义的概念，它还包括其他可能存在的数据，而VO对象主要用于存储变量和函数声明。同时，VO对象是在函数执行时创建的，而词法环境是在函数定义时创建的。



> VO对象中的作用域链是用于查找外部变量的关键机制。实际上，词法环境的作用也正是用于管理这样的作用域链，以及提供一种结构化的方式来管理标识符与其值之间的映射关系。
>
> 词法环境具有以下作用：
>
> 1. 管理标识符的映射关系：词法环境维护了标识符（变量、函数名等）与其值之间的映射关系。当代码中引用一个标识符时，JavaScript引擎会根据当前执行上下文的词法环境来查找标识符的值。词法环境中的环境记录（通常是VO对象）存储了这些映射关系。
> 2. 形成作用域链：词法环境通过外部环境引用来形成作用域链。作用域链是一个由多个词法环境构成的链式结构，它按照代码中的作用域嵌套关系连接在一起。作用域链的存在使得内部函数能够访问外部函数的变量，实现了JavaScript的词法作用域（Lexical Scope）特性。
> 3. 支持变量查找：当在当前函数中引用一个变量时，JavaScript引擎会先在当前词法环境的环境记录中查找该变量。如果找不到，它会顺着作用域链向上查找，直到找到该变量或者达到全局环境（全局对象）为止。
> 4. 实现作用域规则：词法环境帮助确定标识符的可见范围和生命周期。每个函数在定义时都会创建一个新的词法环境，使得函数内部的变量和函数声明在执行过程中具有独立的作用域。
>
> 总之，词法环境是JavaScript引擎管理作用域和标识符的核心数据结构。它通过环境记录存储标识符与值的映射，通过外部环境引用形成作用域链，从而支持变量查找和实现词法作用域规则。作用域链的核心机制在于词法环境，VO对象作为词法环境的一部分，负责存储函数执行上下文中的变量和函数声明



![](..\images\ECMA\词法环境.png)



### 详解：基本执行流程

首先，先用一段代码来理解（相同于之前对执行上下文的理解过程）：

```js
function foo() {
  console.log("foo function")
}

var message = "hellow world"
```

上述是一段简单的代码，现在我们可以了解他的执行过程：

1. ==首先==，上面5句代码会关联一个词法环境，这个词法环境中有一个`环境记录`（因为此时是在全局，所以这个环境记录又叫全局环境记录）；

   这个词法环境中也有一个`outer`，这个outer会被用来记录外层的环境，因为现在这段代码是全局，所以此时outer的值为null；

   在这个词法环境中的环境记录中，会包含一些类似于Date/Object/Function，this，以及函数对象和对应的内存地址，message等等。

2. ==其次==，假设此时要执行这个foo的函数，此时会在执行上下文栈中，创建一个新的执行上下文；

   这个新的执行上下文会关联另外一个新的词法环境，这个新的词法环境也是由环境记录和outer组成；

   这个词法环境的outer的值指向的是全局的词法环境；

   这个函数中如果有一些变量，这些变量会被定义在该词法环境的环境记录中。



也就是说，在ES5之后，==执行一个代码，通常会关联对应的词法环境==；



## 执行上下文关联的词法环境数量

一个执行上下文其实会关联两个词法环境，一个词法环境叫做词法环境（LexicalEnvironment），另外一个词法环境叫做变量环境（VariableEnvironment），这个变量环境本身也是一个词法环境，为什么要关联两个？有什么区别呢？

当我们使用 `let` 和 `const` 来定义一个变量的时候，会使用 `词法环境` 来进行处理，当使用词法环境来处理的时候，它不会进行作用域的提升（在真正被赋值之前不允许被访问，直到它们被赋值，强行访问的时候会被报错:暂时性死区）。

而与之不同的是，`变量环境`用于处理 `var` 和 `function` 声明的标识符，这些标识符创建的变量会被立即初始化！

经过词法环境或者变量环境处理过的变量数据就会放入环境记录中。



## 环境记录（Environment Record）

环境记录的规范中有两种主要的环境记录值：声明式环境记录和对象环境记录。

- 声明式环境记录：声明性环境记录用于定义ECMAScript语言语法元素的效果，如函数声明，变量声明和直接将标识符绑定与ECMAScript语言值关联起来的Catch子句。
- 对象式环境记录：对象环境记录用于定义ECMAScript元素的效果，例如WidthStatement，它将标识符绑定与某些对象的属性关联起来。



如果在环境记录中想要访问一个由let或者const来创建的变量，会先看这个变量现在比环境记录所记录的状态，如果状态是未赋值，就会报错。